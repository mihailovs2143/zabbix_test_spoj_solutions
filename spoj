#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * SPOJ CLI Tool - Interactive problem runner
 * Usage: php spoj
 */

define('SPOJ_CLI_MODE', true);

require_once __DIR__ . '/php/src/Common/ProblemDescriptions.php';

// ANSI Colors
const COLOR_RESET = "\033[0m";
const COLOR_BOLD = "\033[1m";
const COLOR_GREEN = "\033[32m";
const COLOR_BLUE = "\033[34m";
const COLOR_YELLOW = "\033[33m";
const COLOR_RED = "\033[31m";
const COLOR_CYAN = "\033[36m";
const COLOR_GRAY = "\033[90m";

class SpojCLI
{
    private string $projectRoot;
    private array $problems = [];
    private string $inputMode = 'manual';
    private string $outputMode = 'cmd';
    private ?string $inputFile = null;
    private ?string $outputFile = null;

    public function __construct()
    {
        $this->projectRoot = __DIR__;
        $this->scanProblems();
    }

    public function run(): void
    {
        $this->printHeader();
        $this->printMenu();

        while (true) {
            $choice = $this->readInput("\n" . COLOR_CYAN . "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ(ÐœÐµÐ½ÑŽ - m): " . COLOR_RESET);

            switch ($choice) {
                case '0':
                    $this->configureInputMode();
                    break;
                case '1':
                    $this->configureOutputMode();
                    break;
                case '2':
                    $this->selectProblem();
                    break;
                case '3':
                    $this->showStatus();
                    break;
                case '4':
                    $this->runAllTests();
                    break;
                case 'm':
                case 'menu':
                    $this->printMenu();
                    break;
                case 'q':
                case 'exit':
                    $this->printSuccess("Ð”Ð¾ ÑÐ²Ð¸Ð´Ð°Ð½Ð¸Ñ!");
                    exit(0);
                default:
                    $this->printError("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€!");
            }
        }
    }

    private function printHeader(): void
    {
        echo COLOR_BOLD . COLOR_BLUE;
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
        echo "â•‘     SPOJ CLI - Zabbix Interview Solutions     â•‘\n";
        echo "â•‘              Interactive Runner                â•‘\n";
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
        echo COLOR_RESET . "\n";
    }

    private function printMenu(): void
    {
        echo "\n" . COLOR_BOLD . "=== Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ® ===" . COLOR_RESET . "\n\n";
        echo COLOR_YELLOW . "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:" . COLOR_RESET . "\n";
        echo "  0. Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ ÑÐ¿Ð¾ÑÐ¾Ð± Ð²Ð²Ð¾Ð´Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…  [" . COLOR_GREEN . $this->inputMode . COLOR_RESET . "]\n";
        echo "  1. Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ñ‹Ð²Ð¾Ð´Ð°         [" . COLOR_GREEN . $this->outputMode . COLOR_RESET . "]\n";
        echo "\n" . COLOR_YELLOW . "Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ:" . COLOR_RESET . "\n";
        echo "  2. Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ\n";
        echo "  3. ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ\n";
        echo "  4. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ (PHPUnit)\n";
        echo "\n" . COLOR_YELLOW . "ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ:" . COLOR_RESET . "\n";
        echo "  m. ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¼ÐµÐ½ÑŽ\n";
        echo "  q. Ð’Ñ‹Ñ…Ð¾Ð´\n";
    }

    private function configureInputMode(): void
    {
        echo "\n" . COLOR_BOLD . "=== Ð¡ÐŸÐžÐ¡ÐžÐ‘ Ð’Ð’ÐžÐ”Ð Ð”ÐÐÐÐ«Ð¥ ===" . COLOR_RESET . "\n\n";
        echo "1. Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´ (Ð¿Ð¾ÑÑ‚Ñ€Ð¾Ñ‡Ð½Ð¾)\n";
        echo "2. JSON (Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð¹)\n";
        echo "3. Ð˜Ð· Ñ„Ð°Ð¹Ð»Ð° .txt\n";
        echo "0. ÐÐ°Ð·Ð°Ð´\n";

        $choice = $this->readInput("\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ: ");

        switch ($choice) {
            case '1':
                $this->inputMode = 'manual';
                $this->printSuccess("Ð ÐµÐ¶Ð¸Ð¼ Ð²Ð²Ð¾Ð´Ð°: Ð ÑƒÑ‡Ð½Ð¾Ð¹");
                break;
            case '2':
                $this->inputMode = 'json';
                $this->printSuccess("Ð ÐµÐ¶Ð¸Ð¼ Ð²Ð²Ð¾Ð´Ð°: JSON");
                break;
            case '3':
                $this->inputMode = 'file';
                $file = $this->readInput("ÐŸÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ: ");
                if (file_exists($file)) {
                    $this->inputFile = $file;
                    $this->printSuccess("Ð ÐµÐ¶Ð¸Ð¼ Ð²Ð²Ð¾Ð´Ð°: Ð¤Ð°Ð¹Ð» ($file)");
                } else {
                    $this->printError("Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!");
                    $this->inputMode = 'manual';
                }
                break;
            case '0':
                return;
            default:
                $this->printError("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€!");
        }
    }

    private function configureOutputMode(): void
    {
        echo "\n" . COLOR_BOLD . "=== Ð¤ÐžÐ ÐœÐÐ¢ Ð’Ð«Ð’ÐžÐ”Ð ===" . COLOR_RESET . "\n\n";
        echo "1. CMD (ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ, Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚)\n";
        echo "2. CMD JSON (ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ, JSON Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚)\n";
        echo "3. Ð¤Ð°Ð¹Ð» output.txt\n";
        echo "0. ÐÐ°Ð·Ð°Ð´\n";

        $choice = $this->readInput("\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ: ");

        switch ($choice) {
            case '1':
                $this->outputMode = 'cmd';
                $this->printSuccess("Ð ÐµÐ¶Ð¸Ð¼ Ð²Ñ‹Ð²Ð¾Ð´Ð°: CMD");
                break;
            case '2':
                $this->outputMode = 'cmd_json';
                $this->printSuccess("Ð ÐµÐ¶Ð¸Ð¼ Ð²Ñ‹Ð²Ð¾Ð´Ð°: CMD JSON");
                break;
            case '3':
                $this->outputMode = 'file';
                $file = $this->readInput("ÐŸÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ (default: output.txt): ");
                $this->outputFile = empty($file) ? 'output.txt' : $file;
                $this->printSuccess("Ð ÐµÐ¶Ð¸Ð¼ Ð²Ñ‹Ð²Ð¾Ð´Ð°: Ð¤Ð°Ð¹Ð» ({$this->outputFile})");
                break;
            case '0':
                return;
            default:
                $this->printError("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€!");
        }
    }

    private function selectProblem(): void
    {
        if (empty($this->problems)) {
            $this->printError("Ð—Ð°Ð´Ð°Ñ‡Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹!");
            return;
        }

        echo "\n" . COLOR_BOLD . "=== Ð’Ð«Ð‘ÐžÐ  Ð—ÐÐ”ÐÐ§Ð˜ ===" . COLOR_RESET . "\n\n";

        $index = 1;
        $problemsList = [];
        foreach ($this->problems as $problem) {
            echo sprintf("%d. %s\n", $index, COLOR_GREEN . $problem . COLOR_RESET);
            $problemsList[$index] = $problem;
            $index++;
        }
        echo "0. ÐÐ°Ð·Ð°Ð´\n";

        $choice = $this->readInput("\nÐ’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð·Ð°Ð´Ð°Ñ‡Ñƒ: ");

        if ($choice === '0') {
            return;
        }

        $selected = (int) $choice;
        if (!isset($problemsList[$selected])) {
            $this->printError("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€!");
            return;
        }

        $this->runProblem($problemsList[$selected]);
    }

    private function runProblem(string $problem): void
    {
        $problemPath = $this->projectRoot . '/php/problems/' . $problem;
        $solutionFile = $problemPath . '/solution.php';

        if (!file_exists($solutionFile)) {
            $this->printError("Ð¤Ð°Ð¹Ð» Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½: $solutionFile");
            return;
        }

        echo "\n" . COLOR_BOLD . COLOR_BLUE . "=== Ð—Ð°Ð¿ÑƒÑÐº: $problem ===" . COLOR_RESET . "\n\n";

        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        $inputData = $this->getInputData($problem, $problemPath);
        if ($inputData === null || $inputData === '') {
            return;
        }

        // Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ
        $startTime = microtime(true);
        $output = $this->executeProblem($solutionFile, $inputData);
        $executionTime = (microtime(true) - $startTime) * 1000; // ms

        // Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
        $this->displayOutput($output, $executionTime);
    }

    private function getInputData(string $problem, string $problemPath): ?string
    {
        switch ($this->inputMode) {
            case 'manual':
                return $this->getManualInput($problem);
            case 'json':
                return $this->getJsonInput();
            case 'file':
                if ($this->inputFile && file_exists($this->inputFile)) {
                    return file_get_contents($this->inputFile);
                }
                // Fallback to test file
                $testFile = $problemPath . '/test_cases/input1.txt';
                if (file_exists($testFile)) {
                    echo COLOR_YELLOW . "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»: $testFile" . COLOR_RESET . "\n\n";
                    return file_get_contents($testFile);
                }
                $this->printError("Ð¤Ð°Ð¹Ð» Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!");
                return null;
            default:
                return null;
        }
    }

    private function getManualInput(string $problem): string
    {
        echo COLOR_CYAN . "\nðŸ“ Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´ Ð´Ð°Ð½Ð½Ñ‹Ñ…\n" . COLOR_RESET;
        
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸
        try {
            $desc = ProblemDescriptions::getDescription($problem);
            echo COLOR_YELLOW . "Ð—Ð°Ð´Ð°Ñ‡Ð°: " . COLOR_RESET . COLOR_GREEN . $desc['name'] . COLOR_RESET . "\n";
            echo COLOR_GRAY . $desc['description'] . COLOR_RESET . "\n\n";
            
            echo COLOR_YELLOW . "ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð²Ð²Ð¾Ð´Ð°:\n" . COLOR_RESET;
            echo COLOR_GRAY . $desc['example'] . COLOR_RESET . "\n\n";
        } catch (Exception $e) {
            echo COLOR_YELLOW . "ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾\n" . COLOR_RESET;
        }

        // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð±ÑƒÑ„ÐµÑ€ STDIN Ð¿ÐµÑ€ÐµÐ´ Ñ‡Ñ‚ÐµÐ½Ð¸ÐµÐ¼
        if (function_exists('stream_set_blocking')) {
            stream_set_blocking(STDIN, false);
            while (fgets(STDIN) !== false) {
                // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð±ÑƒÑ„ÐµÑ€Ð°
            }
            stream_set_blocking(STDIN, true);
        }

        // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð²Ð²Ð¾Ð´Ð°
        $handler = ProblemDescriptions::getInputHandler($problem);
        
        if ($handler !== null) {
            // Ð¡Ñ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸ÐµÐ¹
            echo COLOR_GREEN . "Ð ÐµÐ¶Ð¸Ð¼: ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ð²Ð²Ð¾Ð´ Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸ÐµÐ¹\n\n" . COLOR_RESET;
            $result = $handler();
            
            // Ð•ÑÐ»Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð²ÐµÑ€Ð½ÑƒÐ» Ð¿ÑƒÑÑ‚ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ - Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
            if ($result === '') {
                echo COLOR_RED . "\nâœ— Ð’Ð²Ð¾Ð´ Ð¾Ñ‚Ð¼ÐµÐ½Ñ‘Ð½ Ð¸Ð·-Ð·Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸\n" . COLOR_RESET;
                return '';
            }
            
            return $result;
        }
        
        // Fallback: ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
        echo COLOR_YELLOW . "Ð ÐµÐ¶Ð¸Ð¼: ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ð¹ Ð²Ð²Ð¾Ð´\n" . COLOR_RESET;
        echo COLOR_YELLOW . "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ð¿ÑƒÑÑ‚Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° Ð´Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ):\n" . COLOR_RESET;
        
        $input = '';
        $lineCount = 0;
        
        while (true) {
            $line = fgets(STDIN);
            
            if ($line === false) {
                break;
            }
            
            // ÐŸÑƒÑÑ‚Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° Ð¸ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ - Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÐ¼
            if (trim($line) === '' && $lineCount > 0) {
                break;
            }
            
            // ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸
            if (trim($line) === '' && $lineCount === 0) {
                continue;
            }
            
            $input .= $line;
            $lineCount++;
        }
        
        return $input;
    }

    private function getJsonInput(): string
    {
        echo COLOR_YELLOW . "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ JSON Ð¼Ð°ÑÑÐ¸Ð² (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: [2, 5, 2, 3, 2, 3, 4]):" . COLOR_RESET . "\n";
        $json = trim(fgets(STDIN));
        $data = json_decode($json, true);

        if ($data === null) {
            $this->printError("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ JSON Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚!");
            return '';
        }

        return implode("\n", $data);
    }

    private function executeProblem(string $solutionFile, string $input): string
    {
        $descriptors = [
            0 => ['pipe', 'r'], // STDIN
            1 => ['pipe', 'w'], // STDOUT
            2 => ['pipe', 'w'], // STDERR
        ];

        $process = proc_open("php $solutionFile", $descriptors, $pipes);

        if (!is_resource($process)) {
            return "ERROR: Cannot start process";
        }

        fwrite($pipes[0], $input);
        fclose($pipes[0]);

        $output = stream_get_contents($pipes[1]);
        fclose($pipes[1]);

        $errors = stream_get_contents($pipes[2]);
        fclose($pipes[2]);

        proc_close($process);
        
        // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð±ÑƒÑ„ÐµÑ€ STDIN Ð¿Ð¾ÑÐ»Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
        if (function_exists('stream_set_blocking')) {
            stream_set_blocking(STDIN, false);
            while (fgets(STDIN) !== false) {
                // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
            }
            stream_set_blocking(STDIN, true);
        }

        if (!empty($errors)) {
            return "STDERR:\n$errors\n\nSTDOUT:\n$output";
        }

        return $output;
    }

    private function displayOutput(string $output, float $executionTime): void
    {
        echo "\n" . COLOR_BOLD . COLOR_GREEN . "=== Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢ ===" . COLOR_RESET . "\n";
        echo COLOR_CYAN . sprintf("Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ: %.2f ms", $executionTime) . COLOR_RESET . "\n\n";

        switch ($this->outputMode) {
            case 'cmd':
                echo $output;
                break;

            case 'cmd_json':
                $lines = array_filter(explode("\n", trim($output)));
                echo json_encode([
                    'execution_time_ms' => round($executionTime, 2),
                    'output' => $lines,
                ], JSON_PRETTY_PRINT) . "\n";
                break;

            case 'file':
                file_put_contents($this->outputFile, $output);
                $this->printSuccess("Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½Ñ‘Ð½ Ð²: {$this->outputFile}");
                echo "\n" . COLOR_YELLOW . "ÐŸÑ€ÐµÐ´Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€:" . COLOR_RESET . "\n";
                echo substr($output, 0, 200) . (strlen($output) > 200 ? "...\n" : "\n");
                break;
        }
    }

    private function showStatus(): void
    {
        echo "\n" . COLOR_BOLD . "=== Ð¢Ð•ÐšÐ£Ð©Ð˜Ð™ Ð¡Ð¢ÐÐ¢Ð£Ð¡ ===" . COLOR_RESET . "\n\n";

        echo COLOR_YELLOW . "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:" . COLOR_RESET . "\n";
        echo "  Ð’Ð²Ð¾Ð´:  " . COLOR_GREEN . $this->inputMode . COLOR_RESET;
        if ($this->inputFile) {
            echo " ($this->inputFile)";
        }
        echo "\n";
        echo "  Ð’Ñ‹Ð²Ð¾Ð´: " . COLOR_GREEN . $this->outputMode . COLOR_RESET;
        if ($this->outputFile) {
            echo " ($this->outputFile)";
        }
        echo "\n\n";

        echo COLOR_YELLOW . "Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ (" . count($this->problems) . "):" . COLOR_RESET . "\n";
        foreach ($this->problems as $problem) {
            $problemPath = $this->projectRoot . '/php/problems/' . $problem;
            $testDir = $problemPath . '/test_cases';
            $testCount = file_exists($testDir) ? count(glob($testDir . '/input*.txt')) : 0;

            echo "  â€¢ " . COLOR_GREEN . $problem . COLOR_RESET;
            echo " (" . $testCount . " Ñ‚ÐµÑÑ‚Ð¾Ð²)\n";
        }
    }

    private function runAllTests(): void
    {
        echo "\n" . COLOR_BOLD . "=== Ð—ÐÐŸÐ£Ð¡Ðš PHPUNIT ===" . COLOR_RESET . "\n\n";

        chdir($this->projectRoot);

        passthru('composer test', $exitCode);

        if ($exitCode === 0) {
            echo "\n";
            $this->printSuccess("Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!");
        } else {
            echo "\n";
            $this->printError("ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ð»Ð¸ÑÑŒ!");
        }
    }

    private function scanProblems(): void
    {
        $problemsDir = $this->projectRoot . '/php/problems';
        if (!is_dir($problemsDir)) {
            return;
        }

        $dirs = scandir($problemsDir);
        foreach ($dirs as $dir) {
            if ($dir === '.' || $dir === '..') {
                continue;
            }

            $path = $problemsDir . '/' . $dir;
            if (is_dir($path) && file_exists($path . '/solution.php')) {
                $this->problems[] = $dir;
            }
        }

        sort($this->problems);
    }

    private function readInput(string $prompt): string
    {
        echo $prompt;
        // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ readline ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾, Ð¸Ð½Ð°Ñ‡Ðµ fgets Ð¸Ð· STDIN
        if (function_exists('readline')) {
            $line = readline();
            return $line !== false ? trim($line) : '';
        }
        
        $line = fgets(STDIN);
        return $line !== false ? trim($line) : '';
    }

    private function printSuccess(string $message): void
    {
        echo COLOR_GREEN . "âœ“ " . $message . COLOR_RESET . "\n";
    }

    private function printError(string $message): void
    {
        echo COLOR_RED . "âœ— " . $message . COLOR_RESET . "\n";
    }
}

// ============================================
// Run CLI
// ============================================

if (php_sapi_name() === 'cli') {
    $cli = new SpojCLI();
    $cli->run();
} else {
    echo "This script must be run from command line.\n";
    exit(1);
}
